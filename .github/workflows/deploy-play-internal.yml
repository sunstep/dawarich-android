name: Deploy to Play Internal

on:
  push:
    branches: [ main ]
    paths:
      - "pubspec.yaml"
      - "lib/**"
      - "android/**"
      - ".github/workflows/**"
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      FLUTTER_CHANNEL: stable
      FLUTTER_VERSION: "3.35.5"
      JAVA_VERSION: "21"
      ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk
      NDK_VERSION: "27.2.12479018"

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Setup Java (Gradle/Android)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle

      - name: Gradle wrapper validation
        uses: gradle/actions/wrapper-validation@v3

      - name: Bootstrap Gradle wrapper script if missing
        shell: bash
        run: |
          set -euxo pipefail
          if [ ! -f "$GITHUB_WORKSPACE/android/gradlew" ]; then
            # read the Gradle version from wrapper properties
            GRADLE_VERSION=$(grep distributionUrl "$GITHUB_WORKSPACE/android/gradle/wrapper/gradle-wrapper.properties" \
              | sed -E 's@.*/gradle-([0-9.]+)-.*@\1@')
            echo "Bootstrapping gradle wrapper using Gradle $GRADLE_VERSION"

            # download a temporary Gradle distro and run the wrapper task
            curl -sSL "https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip" -o gradle.zip
            unzip -q gradle.zip
            ./gradle-*/bin/gradle -p "$GITHUB_WORKSPACE/android" wrapper

            # clean up and ensure executable bit
            rm -rf gradle.zip gradle-*/
            chmod +x "$GITHUB_WORKSPACE/android/gradlew"
          fi
          ls -la "$GITHUB_WORKSPACE/android/gradlew"

      - name: Verify Gradle wrapper (absolute path)
        shell: bash
        run: |
          set -euxo pipefail
          echo "Workspace: $GITHUB_WORKSPACE"
          ls -la "$GITHUB_WORKSPACE/android" || true
          if [ ! -f "$GITHUB_WORKSPACE/android/gradlew" ]; then
            echo "::error file=android/gradlew::Gradle wrapper script missing. Commit android/gradlew and android/gradle/wrapper/*"
            exit 1
          fi
          chmod +x "$GITHUB_WORKSPACE/android/gradlew"

      - name: Restore Android SDK cache
        uses: actions/cache@v4
        with:
          path: ${{ env.ANDROID_SDK_ROOT }}
          key: sdk-${{ runner.os }}-${{ env.NDK_VERSION }}
          restore-keys: |
            sdk-${{ runner.os }}-

      - name: Install Android SDK + NDK (idempotent)
        shell: bash
        env:
          SDK_URL: https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
        run: |
          set -euxo pipefail
          mkdir -p "$ANDROID_SDK_ROOT"

          # 1) Install cmdline-tools if missing (so we get sdkmanager)
          if [ ! -x "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
            tmp=$(mktemp -d)
            curl -sSL "$SDK_URL" -o "$tmp/clt.zip"
            mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
            unzip -q "$tmp/clt.zip" -d "$tmp"
            # zip extracts to 'cmdline-tools'; move it under 'latest'
            mv "$tmp/cmdline-tools" "$ANDROID_SDK_ROOT/cmdline-tools/latest"
            rm -rf "$tmp"
          fi

          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH"

          # 2) Accept licenses (non-fatal if already accepted)
          yes | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" --licenses || true

          # 3) Install required packages (idempotent)
          sdkmanager --sdk_root="$ANDROID_SDK_ROOT" \
            "platform-tools" \
            "platforms;android-35" \
            "build-tools;35.0.0" \
            "ndk;${NDK_VERSION}" \
            "cmake;3.22.1"
          

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      # --- Signing: write files WHERE Gradle expects them
      - name: Decode keystore
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/dawarich-upload.jks
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      - name: Create keystore.properties at ANDROID root
        run: |
          cat > android/keystore.properties <<EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=dawarich-upload.jks
          EOF

      - name: Validate keystore passwords & alias
        run: |
          keytool -list -v -keystore android/dawarich-upload.jks \
            -alias "${{ secrets.ANDROID_KEY_ALIAS }}" \
            -storepass "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
            -keypass "${{ secrets.ANDROID_KEY_PASSWORD }}" >/dev/null

      - name: Write android/local.properties (sdk.dir)
        run: printf "sdk.dir=%s\n" "$ANDROID_SDK_ROOT" > android/local.properties

      - name: Gradle signingReport (early failure)
        shell: bash
        run: |
          "$GITHUB_WORKSPACE/android/gradlew" -p "$GITHUB_WORKSPACE/android" signingReport

      # --- Codegen (Dawarich uses build_runner)
      - name: Run build_runner
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Configure Gradle performance flags
        run: |
          cat >> android/gradle.properties <<'EOF'
          org.gradle.caching=true
          org.gradle.configuration-cache=true
          org.gradle.parallel=true
          org.gradle.daemon=true
          android.enableR8.fullMode=false
          EOF

      - name: Build Android AppBundle (release)
        shell: bash
        run: |
          "$GITHUB_WORKSPACE/android/gradlew" -p "$GITHUB_WORKSPACE/android" bundleRelease --build-cache --stacktrace

      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: app-bundle
          path: android/app/build/outputs/bundle/release/*.aab
          retention-days: 14

  upload:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download AAB
        uses: actions/download-artifact@v4
        with:
          name: app-bundle
          path: dist

      # Optional: read version from pubspec to label the release (nice but not required)
      - name: Read pubspec version
        id: ver
        shell: bash
        run: |
          VLINE=$(grep '^version:' pubspec.yaml | head -1 | awk '{print $2}')
          APP_VERSION="${VLINE%%+*}"
          BUILD_NUMBER="${VLINE##*+}"
          echo "app_version=$APP_VERSION"   >> "$GITHUB_OUTPUT"
          echo "build_number=$BUILD_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Upload to Play (internal track)
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ secrets.PACKAGE_NAME }}
          releaseName: ${{ steps.ver.outputs.app_version }}+${{ steps.ver.outputs.build_number }}
          releaseFiles: dist/*.aab
          whatsNewDirectory: release-notes/android/
          track: internal
          status: draft
