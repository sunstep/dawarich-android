name: GitHub Release (gms + foss)

on:
  push:
    tags:
      - "v*"

  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to build/release"
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    env:
      FLUTTER_CHANNEL: stable
      FLUTTER_VERSION: "3.35.5"
      JAVA_VERSION: "21"

    steps:

      - name: Resolve ref (tag)
        id: ref
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ref=refs/tags/${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "ref=${{ github.ref }}" >> "$GITHUB_OUTPUT"
          fi
      - name: Resolve release metadata
        id: rel
        shell: bash
        run: |
          set -euo pipefail
          TAG=""
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${GITHUB_REF_NAME}"
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.ref.outputs.ref }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Write android/local.properties
        shell: bash
        run: |
          set -e
          SDK_DIR="${ANDROID_SDK_ROOT:-$ANDROID_HOME}"
          FLUTTER_SDK="${FLUTTER_HOME:-$(dirname "$(dirname "$(readlink -f "$(which flutter)")")")}"
          {
            echo "sdk.dir=${SDK_DIR}"
            echo "flutter.sdk=${FLUTTER_SDK}"
          } > android/local.properties

      - name: Make gradlew executable
        run: chmod +x android/gradlew

      # --- Signing (needed for release APK/AAB)
      - name: Decode keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/dawarich-upload.jks

      - name: Create keystore.properties
        run: |
          cat > android/keystore.properties <<'EOF'
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=../dawarich-upload.jks
          EOF

      - name: Read pubspec version (from default pubspec.yaml)
        id: ver
        shell: bash
        run: |
          VLINE=$(grep '^version:' pubspec.yaml | head -1 | awk '{print $2}')
          APP_VERSION="${VLINE%%+*}"
          BUILD_NUMBER="${VLINE##*+}"
          echo "app_version=$APP_VERSION"   >> "$GITHUB_OUTPUT"
          echo "build_number=$BUILD_NUMBER" >> "$GITHUB_OUTPUT"

      # -------------------- GMS build (default pubspec.yaml) --------------------
      - name: Pub get (GMS)
        run: flutter pub get

      - name: Run build_runner (GMS)
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build APK (GMS)
        shell: bash
        run: |
          set -euo pipefail
          flutter build apk --release --flavor gms

      # -------------------- Switch to FOSS pubspec --------------------
      - name: Switch pubspec to FOSS
        shell: bash
        run: |
          set -euo pipefail
          cp pubspec-foss.yaml pubspec.yaml
          cp pubspec-foss.lock pubspec.lock

      - name: Pub get (FOSS)
        run: flutter pub get

      - name: Run build_runner (FOSS)
        run: dart run build_runner build --delete-conflicting-outputs

      - name: FOSS proprietary dependency check
        shell: bash
        run: |
          chmod +x tools/check_proprietary_deps.sh
          tools/check_proprietary_deps.sh fossReleaseRuntimeClasspath

      - name: Build APK (FOSS)
        shell: bash
        run: |
          set -euo pipefail
          flutter build apk --release --flavor foss

      # -------------------- Collect artifacts --------------------
      - name: Collect artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          cp build/app/outputs/flutter-apk/app-gms-release.apk \
            dist/dawarich-${{ steps.ver.outputs.app_version }}+${{ steps.ver.outputs.build_number }}-gms.apk

          cp build/app/outputs/flutter-apk/app-foss-release.apk \
            dist/dawarich-${{ steps.ver.outputs.app_version }}+${{ steps.ver.outputs.build_number }}-foss.apk

          ls -la dist

      - name: Determine prerelease flag
        id: pre
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.rel.outputs.tag }}"
          if [[ "$TAG" == *-* ]]; then
            echo "prerelease=true" >> "$GITHUB_OUTPUT"
          else
            echo "prerelease=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.rel.outputs.tag }}
          target_commitish: ${{ steps.rel.outputs.sha }}
          files: dist/*
          generate_release_notes: false
          fail_on_unmatched_files: true
          prerelease: ${{ steps.pre.outputs.prerelease }}